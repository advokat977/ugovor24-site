<!DOCTYPE html>
<html lang="sr-Latn-ME">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1"
  />
  <title>Ugovor24 — Komandni Centar</title>
  <meta name="robots" content="noindex, nofollow" />

  <!-- Font (Inter) -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap">

  <!-- Supabase SDK v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      /* Brending */
      --brand:#007BFF;
      --brand-2:#20c997;

      /* Tema (dark UI) */
      --bg:#0b0d10;
      --bg-elev:#12151a;
      --panel:#171b22;
      --muted:#8b95a5;
      --text:#e7edf6;
      --warn:#ffb020;
      --error:#e85959;
      --ok:#2ecc71;
      --border:#222834;
      --shadow:0 8px 24px rgba(0,0,0,.25);
      --radius:12px;
      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    html{-webkit-text-size-adjust:100%}
    body{
      margin:0;background:var(--bg);color:var(--text);
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      line-height:1.5;display:flex;min-height:100vh;overflow-x:hidden;
    }
    a{color:inherit;text-decoration:none}

    /* GRID APP */
    .app{
      display:grid;grid-template-columns:260px 1fr;grid-template-rows:auto 1fr;
      grid-template-areas:"side head" "side main";width:100%;
      min-width:0;
    }

    /* SIDEBAR */
    .sidebar{
      grid-area:side;background:var(--panel);border-right:1px solid var(--border);
      display:flex;flex-direction:column;min-height:100vh;position:relative;z-index:40;
      transition:transform .25s ease;
    }
    .brand{display:flex;align-items:center;gap:.75rem;padding:1rem 1.25rem;border-bottom:1px solid var(--border)}
    .brand__logo{width:36px;height:36px;border-radius:8px;background:linear-gradient(135deg,var(--brand),#42a0ff)}
    .brand__name{font-weight:800;letter-spacing:.2px}
    .nav{padding:.75rem}
    .nav button{
      width:100%;text-align:left;background:transparent;border:0;color:var(--text);padding:.65rem .85rem;border-radius:10px;
      display:flex;align-items:center;gap:.6rem;cursor:pointer;font-size:.95rem
    }
    .nav button:hover{background:#132540}
    .nav button.active{background:#0f1d35;outline:1px solid #1d3b74}

    .spacer{flex:1}
    .sidebar__footer{padding:1rem;border-top:1px solid var(--border);color:var(--muted);font-size:.85rem}

    /* HEADER */
    .header{
      grid-area:head;background:var(--panel);border-bottom:1px solid var(--border);
      display:flex;align-items:center;gap:.6rem;padding:.8rem 1rem;position:sticky;top:0;z-index:45
    }
    .search{flex:1;position:relative;min-width:0}
    .search input{
      width:100%;background:var(--bg);border:1px solid var(--border);color:var(--text);border-radius:10px;padding:.7rem .9rem;outline:none
    }
    .header__actions{display:flex;align-items:center;gap:.5rem;flex-wrap:nowrap}
    .btn{
      background:#162131;border:1px solid var(--border);color:var(--text);padding:.55rem .8rem;border-radius:10px;cursor:pointer;font-weight:600
    }
    .btn.primary{background:var(--brand);border-color:transparent}
    .btn.ghost{background:transparent}
    .btn.icon{display:inline-flex;align-items:center;justify-content:center;width:40px;height:40px;padding:0;border-radius:10px}
    .badge{display:inline-flex;align-items:center;gap:.35rem;background:#141c2b;border:1px solid var(--border);border-radius:999px;padding:.25rem .6rem;font-size:.8rem;color:var(--muted)}

    /* Mobile overlay za sidebar */
    .scrim{
      position:fixed;inset:0;background:rgba(0,0,0,.45);backdrop-filter:saturate(80%) blur(2px);
      opacity:0;pointer-events:none;transition:.2s;z-index:35;
    }
    .scrim.show{opacity:1;pointer-events:auto}

    /* Loader bar */
    .loader{position:absolute;left:0;right:0;bottom:-1px;height:2px;background:linear-gradient(90deg,var(--brand),#42a0ff);transform:scaleX(0);transform-origin:left;transition:.25s}
    .loader.on{transform:scaleX(1)}

    /* MAIN */
    .main{grid-area:main;padding:1.25rem;overflow:auto;padding-bottom:calc(1.25rem + var(--safe-bottom))}
    .grid{display:grid;gap:1rem;min-width:0}
    .grid.cards{grid-template-columns:repeat(4,minmax(220px,1fr))}
    .card{
      background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:1rem;min-width:0
    }
    .kpi{display:flex;flex-direction:column;gap:.4rem}
    .kpi .label{color:var(--muted);font-size:.85rem}
    .kpi .value{font-size:1.6rem;font-weight:800}
    .kpi .delta{font-size:.85rem}
    .delta.up{color:var(--brand-2)} .delta.down{color:var(--error)}

    /* TOOLBAR */
    .toolbar{display:flex;gap:.5rem;flex-wrap:wrap;margin:0 0 .75rem}
    .toolbar .input, .toolbar .select{
      background:var(--bg-elev);border:1px solid var(--border);color:var(--text);border-radius:10px;padding:.55rem .7rem;outline:none
    }

    /* TABLES (desktop) */
    .table-wrap{width:100%;overflow-x:auto;-webkit-overflow-scrolling:touch;border-radius:12px}
    table{
      width:100%;border-collapse:collapse;background:var(--panel);border:1px solid var(--border);border-radius:12px;overflow:hidden;
      table-layout:fixed; /* važan fix za iOS wrapping */
      min-width:760px; /* daje širinu za sadržaj i scroll u wrapu na manjim ekranima */
    }
    thead th{background:#141924;color:#aeb7c6;text-align:left;font-weight:600;padding:.75rem;border-bottom:1px solid var(--border);font-size:.9rem;white-space:nowrap}
    tbody td{
      padding:.75rem;border-bottom:1px solid var(--border);font-size:.95rem;
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;vertical-align:middle;
    }
    tbody tr:hover{background:#141a25}
    .status{display:inline-flex;align-items:center;gap:.35rem;padding:.2rem .5rem;border-radius:8px;font-size:.8rem;white-space:nowrap}
    .status.paid{background:#0f2a23;color:#7be0c3;border:1px solid #1f4f44}
    .status.unpaid{background:#2a0f11;color:#ffb1b1;border:1px solid #512325}
    .status.sent{background:#11243a;color:#9ad1ff;border:1px solid #224b74}
    .status.wait{background:#2d2a14;color:#ffe287;border:1px solid #5c5522}
    .actions{display:flex;gap:.4rem;flex-wrap:wrap}
    .btn.small{padding:.35rem .6rem;font-size:.85rem;border-radius:8px}
    .btn.success{background:var(--brand-2);border-color:transparent;color:#062016}
    .btn.warn{background:var(--warn);border-color:transparent;color:#251d00}
    .btn.danger{background:#ff6b6b;border-color:transparent}

    /* LAYOUTS */
    .split{display:grid;grid-template-columns:2fr 1fr;gap:1rem}
    .list{overflow:hidden}
    .aside{position:sticky;top:1rem;height:fit-content}

    /* LOGIN */
    .login-wrap{max-width:420px;margin:8vh auto;padding:1.25rem}
    .login-card{background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:1.25rem}
    .field{display:flex;flex-direction:column;gap:.35rem;margin-bottom:.8rem}
    .field input{background:var(--bg-elev);border:1px solid var(--border);color:#fff;padding:.65rem .75rem;border-radius:10px}
    .error{color:#ff9aa2;font-size:.9rem;margin-top:.35rem}

    /* DRAWER (order details) */
    .drawer{
      position:fixed;inset:auto 0 0 auto;top:0;width:460px;height:100%;
      background:var(--panel);border-left:1px solid var(--border);
      transform:translateX(100%);transition:transform .25s ease;z-index:50;display:flex;flex-direction:column
    }
    .drawer.open{transform:translateX(0)}
    .drawer__head{padding:1rem;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
    .drawer__body{padding:1rem;overflow:auto;display:flex;flex-direction:column;gap:1rem}
    .timeline{display:flex;flex-direction:column;gap:.6rem}
    .tl-item{display:grid;grid-template-columns:18px 1fr;gap:.6rem}
    .dot{width:10px;height:10px;border-radius:50%;background:var(--brand)}
    .muted{color:var(--muted);font-size:.9rem}

    /* TOAST */
    .toast{
      position:fixed;right:16px;bottom:calc(16px + var(--safe-bottom));
      background:#10151d;border:1px solid var(--border);color:var(--text);
      padding:.6rem .75rem;border-radius:10px;box-shadow:var(--shadow);
      opacity:0;transform:translateY(8px);transition:.25s;z-index:60
    }
    .toast.show{opacity:1;transform:translateY(0)}
    .hidden{display:none !important}

    /* ------- MOBILNE NADOGRADNJE ------- */
    .mobile-only{display:none}
    .desktop-only{display:block}

    /* Kartice (mobilni) */
    .cards{display:grid;gap:.75rem}
    .card-row{display:flex;justify-content:space-between;gap:.5rem;align-items:center}
    .pill{display:inline-block;background:#141c2b;border:1px solid var(--border);border-radius:999px;padding:.2rem .55rem;font-size:.8rem;color:#aeb7c6;white-space:nowrap}

    /* Orders cards */
    .orders-cards{display:grid;gap:.75rem}
    .order-card{
      border:1px solid var(--border);border-radius:12px;background:var(--panel);padding:.9rem;display:grid;gap:.5rem
    }
    .order-card .actions{margin-top:.2rem;gap:.4rem;display:flex;flex-wrap:wrap}

    /* Responsive breakpoints */
    @media (max-width: 1200px){
      .grid.cards{grid-template-columns:repeat(3,minmax(180px,1fr))}
    }
    @media (max-width: 1024px){
      .grid.cards{grid-template-columns:repeat(2,minmax(160px,1fr))}
      .split{grid-template-columns:1fr}
      .aside{position:relative;top:auto}
    }
    @media (max-width: 768px){
      /* Layout */
      .app{grid-template-columns:1fr;grid-template-areas:"head" "main"}
      .sidebar{
        position:fixed;inset:0 auto 0 0;width:86%;max-width:300px;transform:translateX(-100%);
        box-shadow:var(--shadow)
      }
      .sidebar.open{transform:translateX(0)}
      .desktop-only{display:none}
      .mobile-only{display:block}

      .header{gap:.5rem;padding-top:calc(.8rem + var(--safe-top))}
      .search input{padding:.6rem .8rem}
      .grid.cards{grid-template-columns:repeat(2,minmax(140px,1fr))}
      .main{padding:1rem}

      /* Tabele sakrij na mobilnom (gdje imamo kartice) */
      .hide-on-mobile{display:none !important}

      /* Drawer kao bottom-sheet */
      .drawer{inset:0;width:100%;border-left:none;border-top:1px solid var(--border);transform:translateY(100%)}
      .drawer.open{transform:translateY(0)}
    }

    /* Fokus (a11y) */
    button:focus-visible, .nav button:focus-visible, input:focus-visible, select:focus-visible {
      outline:2px solid var(--brand); outline-offset:2px;
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- SIDEBAR (overlay na mobilnom) -->
    <aside class="sidebar" id="sidebar">
      <div class="brand">
        <div class="brand__logo"></div>
        <div class="brand__name">Ugovor24 • Admin</div>
      </div>
      <nav class="nav" id="sideNav">
        <button class="active" data-view="dashboard">📊 Dashboard</button>
        <button data-view="orders">🗂️ Narudžbe</button>
        <button data-view="outbox">✉️ Outbox</button>
        <button data-view="documents">📁 Dokumenti</button>
        <button data-view="analytics">📈 Analitika</button>
        <button data-view="settings">⚙️ Podešavanja</button>
      </nav>
      <div class="spacer"></div>
      <div class="sidebar__footer">
        v1.0 • privatno<br />
        <span class="muted">noindex • secured</span>
      </div>
    </aside>
    <div class="scrim" id="scrim"></div>

    <!-- HEADER -->
    <header class="header">
      <!-- Hamburger (mobilni) -->
      <button id="btnMenu" class="btn icon mobile-only" aria-label="Meni">☰</button>
      <div class="badge desktop-only" id="envBadge">Live</div>
      <div class="search"><input id="globalSearch" type="search" placeholder="Pretraga (id/email/ugovor)…" /></div>
      <div class="header__actions">
        <button id="btnRefresh" class="btn ghost" type="button">⟳ Osvježi</button>
        <button id="btnLogout" class="btn" type="button">Odjava</button>
      </div>
      <div id="loader" class="loader"></div>
    </header>

    <!-- MAIN -->
    <main class="main">
      <!-- LOGIN SCREEN -->
      <section id="loginView" class="login-wrap">
        <div class="login-card">
          <h2 style="margin:.25rem 0 1rem">Prijava</h2>
          <div class="field">
            <label for="email">Email</label>
            <input id="email" type="email" placeholder="you@example.com" required inputmode="email" autocomplete="username" />
          </div>
          <div class="field">
            <label for="password">Lozinka</label>
            <input id="password" type="password" placeholder="••••••••" required autocomplete="current-password" />
          </div>
          <button id="btnLogin" class="btn primary" type="button" style="width:100%;margin-top:.5rem">Prijavi se</button>
          <div id="loginErr" class="error hidden"></div>
          <p class="muted" style="margin-top:.8rem">Panel je privatan. Pristup samo uz Supabase nalog.</p>
        </div>
      </section>

      <!-- APP CONTENT -->
      <section id="appView" class="grid hidden">
        <!-- DASHBOARD -->
        <div id="view-dashboard" class="grid">
          <div class="grid cards">
            <div class="card kpi">
              <div class="label">Narudžbe danas</div>
              <div class="value" id="kpiToday">0</div>
              <div class="delta up" id="kpiTodayDelta">—</div>
            </div>
            <div class="card kpi">
              <div class="label">Prihod (30d)</div>
              <div class="value" id="kpiRev30">0 €</div>
              <div class="delta up" id="kpiRevDelta">—</div>
            </div>
            <div class="card kpi">
              <div class="label">Prosječno vrijeme do finala</div>
              <div class="value" id="kpiTTA">—</div>
              <div class="delta" id="kpiTtaNote" style="color:#9fb3c8">cilj &lt; 24h</div>
            </div>
            <div class="card kpi">
              <div class="label">% finalizovano &lt; 24h</div>
              <div class="value" id="kpiF24">—</div>
              <div class="delta up" id="kpiF24Delta">—</div>
            </div>
          </div>

          <div class="split">
            <div class="card list">
              <div class="toolbar">
                <input id="filterSearch" class="input" placeholder="Filter: email / #id / tip ugovora" />
                <select id="filterStatus" class="select">
                  <option value="">Status (sve)</option>
                  <option value="paid">Plaćene</option>
                  <option value="unpaid">Neplaćene</option>
                  <option value="sent">Final poslati</option>
                  <option value="wait">Čeka final</option>
                </select>
                <button id="btnBulkVerify" class="btn small" type="button">✔︎ Verifikuj uplate</button>
                <button id="btnBulkSend" class="btn small primary" type="button">➡︎ Pošalji final</button>
                <button id="btnExportCsv" class="btn small" type="button">⇩ Export CSV</button>
              </div>

              <!-- Tabela (desktop) -->
              <div class="table-wrap desktop-only">
                <table id="ordersTable">
                  <thead>
                    <tr>
                      <th style="width:42px"><input type="checkbox" id="checkAll" /></th>
                      <th style="width:110px">#</th>
                      <th>Ugovor</th>
                      <th>Klijent</th>
                      <th style="width:120px">Iznos</th>
                      <th style="width:120px">Uplata</th>
                      <th style="width:120px">Final</th>
                      <th style="width:340px">Akcije</th>
                    </tr>
                  </thead>
                  <tbody id="ordersTbody"><tr><td colspan="8" style="text-align:center;color:#8b95a5">Učitavam…</td></tr></tbody>
                </table>
              </div>

              <!-- Kartice (mobilni) -->
              <div id="ordersCards" class="orders-cards mobile-only" aria-live="polite"></div>
            </div>

            <div class="aside">
              <div class="card">
                <h3 style="margin:0 0 .4rem">Critical Queue</h3>
                <p class="muted" style="margin:.2rem 0 1rem">Plaćeno, a nema finala; greške slanja; bez fiskalnog.</p>
                <ul id="criticalList" style="margin:0;padding-left:1.1rem"></ul>
              </div>
              <div class="card" style="margin-top:1rem">
                <h3 style="margin:0 0 .4rem">Sistem status</h3>
                <p id="sysStatus" class="muted">Realtime: — • Cron: — • Storage: —</p>
              </div>
            </div>
          </div>
        </div>

        <!-- NARUDŽBE (full-screen) -->
        <div id="view-orders" class="card hidden">
          <div class="toolbar">
            <input id="ordersFilterSearch" class="input" placeholder="Filter: email / #id / tip ugovora" />
            <select id="ordersFilterStatus" class="select">
              <option value="">Status (sve)</option>
              <option value="paid">Plaćene</option>
              <option value="unpaid">Neplaćene</option>
              <option value="sent">Final poslati</option>
              <option value="wait">Čeka final</option>
            </select>
            <button id="ordersExportCsv" class="btn small" type="button">⇩ Export CSV</button>
          </div>

          <!-- Desktop tabela -->
          <div class="table-wrap desktop-only">
            <table>
              <thead>
                <tr>
                  <th style="width:42px"><input type="checkbox" id="ordersCheckAll" /></th>
                  <th style="width:110px">#</th><th>Ugovor</th><th>Klijent</th><th style="width:120px">Iznos</th><th style="width:120px">Uplata</th><th style="width:120px">Final</th><th style="width:340px">Akcije</th>
                </tr>
              </thead>
              <tbody id="ordersViewTbody"><tr><td colspan="8" style="text-align:center;color:#8b95a5">Učitavam…</td></tr></tbody>
            </table>
          </div>

          <!-- Mobilne kartice -->
          <div id="ordersViewCards" class="orders-cards mobile-only"></div>
        </div>

        <!-- OUTBOX -->
        <div id="view-outbox" class="card hidden">
          <div class="toolbar">
            <select id="outboxStatus" class="select">
              <option value="">Status (sve)</option>
              <option value="queued">queued</option>
              <option value="sent">sent</option>
              <option value="delivered">delivered</option>
              <option value="failed">failed</option>
              <option value="bounced">bounced</option>
            </select>
            <input id="outboxSearch" class="input" placeholder="Pretraga: email / subject" />
            <button id="outboxRefresh" class="btn small" type="button">⟳ Osvježi</button>
          </div>

          <!-- Desktop tabela -->
          <div class="table-wrap desktop-only">
            <table>
              <thead>
                <tr><th style="width:190px">Vrijeme</th><th>Kome</th><th>Predmet</th><th style="width:140px">Šablon</th><th style="width:120px">Status</th><th style="width:160px">Provider ID</th></tr>
              </thead>
              <tbody id="outboxTbody"><tr><td colspan="6" style="text-align:center;color:#8b95a5">Učitavam…</td></tr></tbody>
            </table>
          </div>

          <!-- mobilni outbox (kartice) -->
          <div id="outboxCards" class="orders-cards mobile-only"></div>
          <p id="outboxInfo" class="muted" style="margin:.6rem 0 0"></p>
        </div>

        <!-- DOKUMENTI -->
        <div id="view-documents" class="card hidden">
          <div class="toolbar">
            <input id="docsOrderId" class="input" placeholder="ID narudžbe (broj ili UUID)" style="width:220px" />
            <button id="docsLoad" class="btn small" type="button">Prikaži fajlove</button>
            <span class="muted">Bucket: <code>ugovori</code></span>
          </div>
          <div class="table-wrap">
            <table>
              <thead>
                <tr><th>Fajl</th><th style="width:120px">Veličina</th><th style="width:190px">Modifikovano</th><th style="width:120px"></th></tr>
              </thead>
              <tbody id="docsTbody"><tr><td colspan="4" style="text-align:center;color:#8b95a5">Unesi ID narudžbe i klikni "Prikaži fajlove".</td></tr></tbody>
            </table>
          </div>
        </div>

        <!-- ANALITIKA -->
        <div id="view-analytics" class="grid hidden">
          <div class="grid cards">
            <div class="card kpi">
              <div class="label">Narudžbi (30d)</div>
              <div class="value" id="anCnt30">—</div>
            </div>
            <div class="card kpi">
              <div class="label">Prihod (30d)</div>
              <div class="value" id="anRev30">—</div>
            </div>
            <div class="card kpi">
              <div class="label">Prosječna cijena</div>
              <div class="value" id="anAvg">—</div>
            </div>
            <div class="card kpi">
              <div class="label">Top tip</div>
              <div class="value" id="anTopType">—</div>
            </div>
          </div>

          <div class="split">
            <div class="card">
              <h3 style="margin:0 0 .4rem">Top tipovi ugovora</h3>
              <div class="table-wrap">
                <table>
                  <thead><tr><th>Tip</th><th style="width:120px">Količina</th><th style="width:160px">Prihod</th></tr></thead>
                  <tbody id="anTypesTbody"><tr><td colspan="3" style="text-align:center;color:#8b95a5">Učitavam…</td></tr></tbody>
                </table>
              </div>
            </div>
            <div class="aside">
              <div class="card">
                <h3 style="margin:0 0 .4rem">Prihod po danu (14d)</h3>
                <div class="table-wrap">
                  <table>
                    <thead><tr><th>Dan</th><th style="width:160px">Prihod</th></tr></thead>
                    <tbody id="anDaysTbody"><tr><td colspan="2" style="text-align:center;color:#8b95a5">Učitavam…</td></tr></tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- PODEŠAVANJA -->
        <div id="view-settings" class="card hidden">
          <h3 style="margin:0 0 .6rem">Podešavanja</h3>
          <p class="muted">Email šabloni, rok signed linkova, podsjetnici (uskoro).</p>
          <div class="grid" style="grid-template-columns:repeat(2,minmax(220px,1fr));gap:1rem;margin-top:1rem">
            <div class="card">
              <strong>Okruženje</strong>
              <p class="muted" id="envInfo">—</p>
            </div>
            <div class="card">
              <strong>Test konekcije</strong><br />
              <button id="btnPing" class="btn small" type="button">Ping DB</button>
              <span id="pingResult" class="muted" style="margin-left:.5rem">—</span>
            </div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- DRAWER: Order details -->
  <div id="drawer" class="drawer" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="drawer__head">
      <strong id="drawerTitle">Narudžba</strong>
      <div style="display:flex;gap:.5rem">
        <button id="btnDrawerSend" class="btn small primary" type="button">Pošalji final</button>
        <button id="btnDrawerClose" class="btn small" type="button">Zatvori</button>
      </div>
    </div>
    <div class="drawer__body">
      <div>
        <div class="muted">Klijent</div>
        <div id="drawerClient">—</div>
      </div>
      <div>
        <div class="muted">Tip ugovora</div>
        <div id="drawerType">—</div>
      </div>
      <div>
        <div class="muted">Iznos</div>
        <div id="drawerAmount">—</div>
      </div>
      <div>
        <div class="muted">Finalni fajl</div>
        <input id="drawerFile" type="file" />
      </div>

      <div>
        <div class="muted" style="margin-bottom:.25rem">Timeline</div>
        <div id="drawerTimeline" class="timeline"></div>
      </div>
    </div>
  </div>

  <!-- TOAST -->
  <div id="toast" class="toast">Poruka</div>

  <script>
    "use strict";

    /***** CONFIG — Supabase *****/
    const SUPABASE_URL = "https://jgkllsxeuoozpglzwxwg.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impna2xsc3hldW9venBnbHp3eHdnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ5MjEyNjgsImV4cCI6MjA3MDQ5NzI2OH0.vEaqZbeoVK1MOdVL6mm7CoABRuuJUcuOXT5-IfZSUsc";
    const API_FINALIZE = "/api/finalize-contract.js";

    // SDK guard
    if (!window.supabase || typeof window.supabase.createClient !== "function") {
      alert("Supabase SDK nije učitan. Provjeri mrežu/CSP/AdBlock i script src.");
      console.error("Supabase SDK missing: window.supabase =", window.supabase);
    }
    const supabase = window.supabase?.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    /***** STATE *****/
    let orders = [];
    let rawOrders = [];
    let selectedIds = new Set();
    let currentOrder = null;
    let isMobile = window.matchMedia("(max-width: 768px)").matches;

    /***** ELEMENTS *****/
    const loginView = document.getElementById("loginView");
    const appView   = document.getElementById("appView");
    const loginErr  = document.getElementById("loginErr");
    const btnLogin  = document.getElementById("btnLogin");
    const btnLogout = document.getElementById("btnLogout");
    const btnRefresh= document.getElementById("btnRefresh");
    const loaderBar = document.getElementById("loader");

    const sidebar   = document.getElementById("sidebar");
    const btnMenu   = document.getElementById("btnMenu");
    const scrim     = document.getElementById("scrim");
    const nav       = document.querySelector(".nav");
    const views = {
      dashboard: document.getElementById("view-dashboard"),
      orders: document.getElementById("view-orders"),
      outbox: document.getElementById("view-outbox"),
      documents: document.getElementById("view-documents"),
      analytics: document.getElementById("view-analytics"),
      settings: document.getElementById("view-settings"),
    };

    const filterSearch = document.getElementById("filterSearch");
    const filterStatus = document.getElementById("filterStatus");
    const ordersTbody  = document.getElementById("ordersTbody");
    const ordersCards  = document.getElementById("ordersCards");
    const checkAll     = document.getElementById("checkAll");
    const criticalList = document.getElementById("criticalList");

    const kpiToday = document.getElementById("kpiToday");
    const kpiRev30 = document.getElementById("kpiRev30");

    const drawer = document.getElementById("drawer");
    const drawerTitle = document.getElementById("drawerTitle");
    const drawerClient = document.getElementById("drawerClient");
    const drawerType = document.getElementById("drawerType");
    const drawerAmount = document.getElementById("drawerAmount");
    const drawerFile = document.getElementById("drawerFile");
    const drawerTimeline = document.getElementById("drawerTimeline");
    const btnDrawerClose = document.getElementById("btnDrawerClose");
    const btnDrawerSend  = document.getElementById("btnDrawerSend");

    const toast = document.getElementById("toast");
    const globalSearch = document.getElementById("globalSearch");

    const outboxTbody = document.getElementById("outboxTbody");
    const outboxCards = document.getElementById("outboxCards");
    const outboxInfo  = document.getElementById("outboxInfo");

    /***** UTIL *****/
    const fmtMoney = v => Intl.NumberFormat("sr-ME",{style:"currency",currency:"EUR",maximumFractionDigits:0}).format(v||0);
    const pad = (n, w=5) => String(n).padStart(w,"0");
    function show(el){ el.classList.remove("hidden"); }
    function hide(el){ el.classList.add("hidden"); }
    const loading = (on)=> loaderBar.classList.toggle("on", !!on);
    function showToast(msg){ toast.textContent = msg; toast.classList.add("show"); setTimeout(()=>toast.classList.remove("show"), 1800); }
    function setView(name){
      Object.entries(views).forEach(([k,el]) => (k===name)?show(el):hide(el));
      document.querySelectorAll(".nav button").forEach(b=>b.classList.toggle("active", b.dataset.view===name));
      closeMenu();
    }

    /* Mobile menu */
    function openMenu(){ sidebar.classList.add("open"); scrim.classList.add("show"); }
    function closeMenu(){ sidebar.classList.remove("open"); scrim.classList.remove("show"); }

    /* KPIs */
    function renderKPIs(){
      const today = new Date().toDateString();
      const todayCount = orders.filter(o => new Date(o.created_at).toDateString()===today).length;
      const revenue30 = orders.reduce((s,o)=>{
        const d = new Date(o.created_at);
        const diff = (Date.now()-d.getTime())/86400000;
        return diff<=30 ? s + (Number(o.total_price)||0) : s;
      },0);
      kpiToday.textContent = todayCount;
      kpiRev30.textContent = fmtMoney(revenue30);
    }

    function statusBadge(o){
      const s1 = o.is_paid ? '<span class="status paid">Uplaćeno</span>' : '<span class="status unpaid">Na čekanju</span>';
      const s2 = o.is_final_approved ? '<span class="status sent">Poslato</span>' : '<span class="status wait">Čeka</span>';
      return [s1,s2];
    }

    /***** RENDER: tabela (desktop) *****/
    function renderTable(){
      ordersTbody.innerHTML = "";
      selectedIds.clear();
      checkAll.checked = false;

      const txt = (filterSearch.value||"").toLowerCase();
      const st = filterStatus.value;

      const filtered = orders.filter(o=>{
        const hit = !txt
          || String(o.order_number).includes(txt)
          || (o.client_email||"").toLowerCase().includes(txt)
          || (o.ugovor_type||"").toLowerCase().includes(txt);
        if(!hit) return false;
        if(st==="paid" && !o.is_paid) return false;
        if(st==="unpaid" && o.is_paid) return false;
        if(st==="sent" && !o.is_final_approved) return false;
        if(st==="wait" && o.is_final_approved) return false;
        return true;
      });

      for(const o of filtered){
        const tr = document.createElement("tr");
        const [sPaid, sFinal] = statusBadge(o);
        tr.innerHTML = `
          <td><input type="checkbox" data-id="${o.id}"></td>
          <td>#${pad(o.order_number||o.id)}</td>
          <td title="${o.ugovor_type||""}">${o.ugovor_type||"—"}</td>
          <td title="${o.client_email||""}">${o.client_email||"—"}</td>
          <td>${fmtMoney(Number(o.total_price||0))}</td>
          <td>${sPaid}</td>
          <td>${sFinal}</td>
          <td class="actions">
            ${!o.is_paid ? `<button class="btn small success" data-act="verify" data-id="${o.id}" type="button">Verifikuj</button>` : ``}
            <button class="btn small" data-act="upload" data-id="${o.id}" type="button">Priloži</button>
            ${(o.is_paid && !o.is_final_approved && o.final_document_url) ? `<button class="btn small primary" data-act="send" data-id="${o.id}" type="button">Pošalji</button>` : ``}
            <button class="btn small" data-act="open" data-id="${o.id}" type="button">Detalji</button>
          </td>
        `;
        ordersTbody.appendChild(tr);
      }
      renderCritical();
    }

    /***** RENDER: kartice (mobilni) *****/
    function renderCards(targetEl){
      const listEl = targetEl || ordersCards;
      const useFilters = !targetEl; // na view-orders koristimo posebne filtere
      const txt = (useFilters ? (filterSearch.value||"") : (document.getElementById("ordersFilterSearch").value||"")).toLowerCase();
      const st =  (useFilters ? filterStatus.value : document.getElementById("ordersFilterStatus").value);

      const filtered = orders.filter(o=>{
        const hit = !txt
          || String(o.order_number).includes(txt)
          || (o.client_email||"").toLowerCase().includes(txt)
          || (o.ugovor_type||"").toLowerCase().includes(txt);
        if(!hit) return false;
        if(st==="paid" && !o.is_paid) return false;
        if(st==="unpaid" && o.is_paid) return false;
        if(st==="sent" && !o.is_final_approved) return false;
        if(st==="wait" && o.is_final_approved) return false;
        return true;
      });

      listEl.innerHTML = filtered.map(o=>{
        const [sPaid, sFinal] = statusBadge(o);
        const amount = fmtMoney(Number(o.total_price||0));
        return `
          <div class="order-card" data-id="${o.id}">
            <div class="card-row">
              <strong>#${pad(o.order_number||o.id)}</strong>
              <span class="pill" title="${o.ugovor_type||""}">${o.ugovor_type||"—"}</span>
            </div>
            <div class="card-row">
              <span class="muted" title="${o.client_email||""}">${o.client_email||"—"}</span>
              <span>${amount}</span>
            </div>
            <div class="card-row" style="gap:.5rem;flex-wrap:wrap">
              <span>${sPaid}</span>
              <span>${sFinal}</span>
            </div>
            <div class="actions">
              ${!o.is_paid ? `<button class="btn small success" data-act="verify" data-id="${o.id}" type="button">Verifikuj</button>` : ``}
              <button class="btn small" data-act="upload" data-id="${o.id}" type="button">Priloži</button>
              ${(o.is_paid && !o.is_final_approved && o.final_document_url) ? `<button class="btn small primary" data-act="send" data-id="${o.id}" type="button">Pošalji</button>` : ``}
              <button class="btn small" data-act="open" data-id="${o.id}" type="button">Detalji</button>
            </div>
          </div>
        `;
      }).join("") || `<div class="muted">Nema stavki.</div>`;
    }

    function renderCritical(){
      const items = orders.filter(o => (o.is_paid && !o.is_final_approved));
      if(items.length===0){ criticalList.innerHTML = `<li class="muted">Nema kritičnih stavki.</li>`; return;}
      criticalList.innerHTML = items.map(o=>`<li>#${pad(o.order_number)} • ${o.client_email} • čeka final</li>`).join("");
    }

    function openDrawer(order){
      currentOrder = order;
      drawerTitle.textContent = `Narudžba #${pad(order.order_number||order.id)}`;
      drawerClient.textContent = order.client_email || "—";
      drawerType.textContent   = order.ugovor_type || "—";
      drawerAmount.textContent = fmtMoney(Number(order.total_price||0));
      drawerTimeline.innerHTML = `
        <div class="tl-item"><div class="dot"></div><div>Kreirano <div class="muted">${new Date(order.created_at).toLocaleString()}</div></div></div>
        <div class="tl-item"><div class="dot" style="background:${order.is_paid?'#20c997':'#555'}"></div><div>Uplata ${order.is_paid?'potvrđena':'na čekanju'}</div></div>
        <div class="tl-item"><div class="dot" style="background:${order.final_document_url?'#42a0ff':'#555'}"></div><div>Finalni fajl ${order.final_document_url?'priložen':'nije priložen'}</div></div>
        <div class="tl-item"><div class="dot" style="background:${order.is_final_approved?'#42a0ff':'#555'}"></div><div>Final poslat ${order.is_final_approved?'✓':'—'}</div></div>
      `;
      drawer.classList.add("open");
      drawer.setAttribute("aria-hidden","false");
    }
    function closeDrawer(){
      drawer.classList.remove("open");
      drawer.setAttribute("aria-hidden","true");
      currentOrder = null;
      drawerFile.value = "";
    }

    /***** AUTH *****/
    async function checkSession(){
      if(!supabase) return null;
      try{
        const { data:{ session } } = await supabase.auth.getSession();
        return session;
      }catch(e){ console.error("getSession error:", e); return null; }
    }
    async function showApp(){ hide(loginView); show(appView); setView("dashboard"); }
    async function showLogin(){ show(loginView); hide(appView); }

    async function doLogin(){
      const email = document.getElementById("email").value.trim();
      const password = document.getElementById("password").value;
      if(!supabase){
        loginErr.textContent = "SDK nije učitan — provjeri mrežu ili CSP.";
        loginErr.classList.remove("hidden");
        return;
      }
      loginErr.classList.add("hidden");
      loading(true);
      try{
        const { data, error } = await supabase.auth.signInWithPassword({ email, password });
        if(error){
          loginErr.textContent = error.message || "Greška pri prijavi.";
          loginErr.classList.remove("hidden");
          return;
        }
        await showApp();
        await fetchOrders();
        subscribeRealtime();
      }catch(e){
        console.error("Login exception:", e);
        loginErr.textContent = "Neočekivana greška pri prijavi (detalji u Console).";
        loginErr.classList.remove("hidden");
      }finally{
        loading(false);
      }
    }

    /***** DATA FETCH *****/
    async function fetchOrders(){
      if(!supabase) return;
      loading(true);
      try{
        const { data, error } = await supabase.from("orders").select("*").order("created_at",{ascending:false});
        if(error){
          console.error(error);
          ordersTbody.innerHTML = `<tr><td colspan="8" style="text-align:center;color:#e85959">Greška pri učitavanju narudžbi.</td></tr>`;
          ordersCards.innerHTML = `<div class="muted">Greška pri učitavanju.</div>`;
          return;
        }
        rawOrders = data||[];
        orders = [...rawOrders];
        renderKPIs();
        renderResponsiveOrders();
      }finally{
        loading(false);
      }
    }

    function renderResponsiveOrders(){
      if(isMobile){
        renderCards(ordersCards);
      }else{
        renderTable();
      }
    }

    /************ ORDERS VIEW (pun ekran) ************/
    function renderOrdersView(){
      const tbody = document.getElementById("ordersViewTbody");
      const txt = (document.getElementById("ordersFilterSearch").value||"").toLowerCase();
      const st  = document.getElementById("ordersFilterStatus").value;
      const filtered = orders.filter(o=>{
        const hit = !txt
          || String(o.order_number).includes(txt)
          || (o.client_email||"").toLowerCase().includes(txt)
          || (o.ugovor_type||"").toLowerCase().includes(txt);
        if(!hit) return false;
        if(st==="paid" && !o.is_paid) return false;
        if(st==="unpaid" && o.is_paid) return false;
        if(st==="sent" && !o.is_final_approved) return false;
        if(st==="wait" && o.is_final_approved) return false;
        return true;
      });

      // desktop tabela
      tbody.innerHTML = "";
      for(const o of filtered){
        const [sPaid, sFinal] = statusBadge(o);
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td><input type="checkbox" data-id="${o.id}"></td>
          <td>#${pad(o.order_number||o.id)}</td>
          <td title="${o.ugovor_type||""}">${o.ugovor_type||"—"}</td>
          <td title="${o.client_email||""}">${o.client_email||"—"}</td>
          <td>${fmtMoney(Number(o.total_price||0))}</td>
          <td>${sPaid}</td>
          <td>${sFinal}</td>
          <td class="actions">
            ${!o.is_paid ? `<button class="btn small success" data-act="verify" data-id="${o.id}" type="button">Verifikuj</button>` : ``}
            <button class="btn small" data-act="upload" data-id="${o.id}" type="button">Priloži</button>
            ${(o.is_paid && !o.is_final_approved && o.final_document_url) ? `<button class="btn small primary" data-act="send" data-id="${o.id}" type="button">Pošalji</button>` : ``}
            <button class="btn small" data-act="open" data-id="${o.id}" type="button">Detalji</button>
          </td>
        `;
        tbody.appendChild(tr);
      }

      // mobilne kartice
      const cardsEl = document.getElementById("ordersViewCards");
      cardsEl.innerHTML = ""; // biće popunjeno kroz renderCards sa targetom
      renderCards(cardsEl);
    }

    /************ OUTBOX ************/
    async function fetchOutbox(){
      outboxInfo.textContent = "";
      if(!supabase) return;
      try{
        const { data, error } = await supabase.from("email_outbox")
          .select("*")
          .order("created_at",{ascending:false})
          .limit(200);

        const st = document.getElementById("outboxStatus").value;
        const q  = (document.getElementById("outboxSearch").value||"").toLowerCase();

        if(error){
          if(outboxTbody) outboxTbody.innerHTML = `<tr><td colspan="6" style="text-align:center;color:#e85959">Outbox tabela nedostaje.</td></tr>`;
          outboxCards.innerHTML = `<div class="muted">Outbox tabela nedostaje.</div>`;
          outboxInfo.innerHTML = `Napomena: kreiraj tabelu <code>public.email_outbox</code>.`;
          return;
        }

        const rows = (data||[]).filter(r=>{
          const ok1 = !st || r.status===st;
          const ok2 = !q  || (String(r.to||"").toLowerCase().includes(q) || String(r.subject||"").toLowerCase().includes(q));
          return ok1 && ok2;
        });

        // Desktop tabela
        if(outboxTbody){
          outboxTbody.innerHTML = rows.map(r=>`
            <tr>
              <td>${new Date(r.created_at).toLocaleString()}</td>
              <td title="${r.to||""}">${r.to||"—"}</td>
              <td title="${r.subject||""}">${r.subject||"—"}</td>
              <td>${r.template||"—"}</td>
              <td>${r.status||"—"}</td>
              <td title="${r.provider_id||""}">${r.provider_id||"—"}</td>
            </tr>
          `).join("") || `<tr><td colspan="6" style="text-align:center;color:#8b95a5">Nema stavki.</td></tr>`;
        }

        // Mobilne kartice
        outboxCards.innerHTML = rows.map(r=>`
          <div class="order-card">
            <div class="card-row">
              <strong>${r.subject||"—"}</strong>
              <span class="pill">${r.status||"—"}</span>
            </div>
            <div class="card-row"><span class="muted">${new Date(r.created_at).toLocaleString()}</span></div>
            <div class="card-row"><span>Kome:</span><span class="muted">${r.to||"—"}</span></div>
            <div class="card-row"><span>Šablon:</span><span class="muted">${r.template||"—"}</span></div>
            <div class="card-row"><span>Provider:</span><span class="muted">${r.provider_id||"—"}</span></div>
          </div>
        `).join("") || `<div class="muted">Nema stavki.</div>`;
      }catch(e){
        console.error(e);
        if(outboxTbody) outboxTbody.innerHTML = `<tr><td colspan="6" style="text-align:center;color:#e85959">Greška pri učitavanju Outbox-a.</td></tr>`;
        outboxCards.innerHTML = `<div class="muted">Greška pri učitavanju Outbox-a.</div>`;
      }
    }

    /************ DOKUMENTI (bucket 'ugovori') ************/
    async function listDocs(orderId){
      const tbody = document.getElementById("docsTbody");
      if(!orderId){ tbody.innerHTML = `<tr><td colspan="4" style="text-align:center;color:#8b95a5">Unesi ID narudžbe.</td></tr>`; return; }
      tbody.innerHTML = `<tr><td colspan="4" style="text-align:center;color:#8b95a5">Učitavam…</td></tr>`;
      try{
        const { data, error } = await supabase.storage.from("ugovori").list(`${orderId}`, { limit: 100 });
        if(error){ console.error(error); tbody.innerHTML = `<tr><td colspan="4" style="text-align:center;color:#e85959">Greška pri listanju.</td></tr>`; return; }
        if(!data || data.length===0){ tbody.innerHTML = `<tr><td colspan="4" style="text-align:center;color:#8b95a5">Nema fajlova.</td></tr>`; return; }

        tbody.innerHTML = data.map(f=>{
          const path = `${orderId}/${f.name}`;
          const { data:pub } = supabase.storage.from("ugovori").getPublicUrl(path);
          const url = pub?.publicUrl || "#";
          const size = (f?.metadata?.size || f?.size || 0);
          const sizeKB = size ? Math.round(size/1024) + " KB" : "—";
          const mod = f?.updated_at ? new Date(f.updated_at).toLocaleString() : "—";
          return `<tr>
            <td title="${f.name}">${f.name}</td>
            <td>${sizeKB}</td>
            <td>${mod}</td>
            <td><a class="btn small" href="${url}" target="_blank" rel="noopener">Preuzmi</a></td>
          </tr>`;
        }).join("");
      }catch(e){
        console.error(e);
        tbody.innerHTML = `<tr><td colspan="4" style="text-align:center;color:#e85959">Neočekivana greška.</td></tr>`;
      }
    }

    /************ ANALITIKA ************/
    function recomputeAnalytics(){
      const now = Date.now();
      const days = 14;
      const byDay = new Map();
      const byType = new Map();
      let cnt30=0, rev30=0;

      for(const o of orders){
        const t = new Date(o.created_at).getTime();
        const dDiff = (now - t)/86400000;
        if(dDiff<=30){ cnt30++; rev30 += Number(o.total_price)||0; }

        const d = new Date(o.created_at); const key = d.toISOString().slice(0,10);
        byDay.set(key, (byDay.get(key)||0) + (Number(o.total_price)||0));

        const type = (o.ugovor_type||"—");
        const agg = byType.get(type)||{cnt:0,rev:0};
        agg.cnt++; agg.rev += Number(o.total_price)||0;
        byType.set(type, agg);
      }

      document.getElementById("anCnt30").textContent = cnt30;
      document.getElementById("anRev30").textContent = fmtMoney(rev30);
      document.getElementById("anAvg").textContent = cnt30? fmtMoney(rev30/cnt30) : "—";
      const top = [...byType.entries()].sort((a,b)=>b[1].cnt-a[1].cnt)[0];
      document.getElementById("anTopType").textContent = top? `${top[0]} (${top[1].cnt})` : "—";

      const typesTbody = document.getElementById("anTypesTbody");
      typesTbody.innerHTML = [...byType.entries()].sort((a,b)=>b[1].cnt-a[1].cnt).map(([k,v])=>`
        <tr><td title="${k}">${k}</td><td>${v.cnt}</td><td>${fmtMoney(v.rev)}</td></tr>
      `).join("") || `<tr><td colspan="3" style="text-align:center;color:#8b95a5">Nema podataka.</td></tr>`;

      const daysTbody = document.getElementById("anDaysTbody");
      const rows = [];
      for(let i=days-1;i>=0;i--){
        const d = new Date(now - i*86400000).toISOString().slice(0,10);
        rows.push(`<tr><td>${d}</td><td>${fmtMoney(byDay.get(d)||0)}</td></tr>`);
      }
      daysTbody.innerHTML = rows.join("");
    }

    /***** ACTIONS via /api *****/
    async function getToken(){
      const session = await checkSession();
      return session ? session.access_token : null;
    }

    async function actVerify(id){
      const token = await getToken();
      if(!token){ showToast("Sesija istekla"); return; }
      loading(true);
      const res = await fetch(API_FINALIZE,{method:"POST",headers:{'Content-Type':'application/json','Authorization':`Bearer ${token}`},body:JSON.stringify({action:"verify_payment",order_id:id})});
      loading(false);
      if(res.ok){ showToast("Uplata verifikovana"); fetchOrders(); } else showToast("Greška pri verifikaciji");
    }

    async function actUpload(id, file){
      if(!file){ showToast("Izaberi fajl"); return; }
      const token = await getToken(); if(!token){ showToast("Sesija istekla"); return; }
      loading(true);
      const { data, error } = await supabase.storage.from("ugovori").upload(`${id}/${file.name}`, file, { cacheControl:"3600", upsert:true });
      if(error){ loading(false); console.error(error); showToast("Greška upload"); return; }
      const fileUrl = `${SUPABASE_URL}/storage/v1/object/public/ugovori/${data.path}`;
      const res = await fetch(API_FINALIZE,{method:"POST",headers:{'Content-Type':'application/json','Authorization':`Bearer ${token}`},body:JSON.stringify({action:"upload_file",order_id:id,fileUrl})});
      loading(false);
      res.ok ? (showToast("Ugovor priložen"), fetchOrders()) : showToast("Greška pri prilaganju");
    }

    async function actSend(id){
      const token = await getToken(); if(!token){ showToast("Sesija istekla"); return; }
      loading(true);
      const res = await fetch(API_FINALIZE,{method:"POST",headers:{'Content-Type':'application/json','Authorization':`Bearer ${token}`},body:JSON.stringify({action:"send_final",order_id:id})});
      loading(false);
      if(res.ok){ showToast("Final poslat"); fetchOrders(); }
      else{ try{ const j=await res.json(); showToast("Greška: "+(j.error||"Nepoznata")); }catch{ showToast("Greška pri slanju"); } }
    }

    /***** EVENT BINDINGS *****/
    document.addEventListener("DOMContentLoaded", async ()=>{
      // Media listener (switch tabela/kartice na resize)
      const mq = window.matchMedia("(max-width: 768px)");
      function onMedia(e){ isMobile = e.matches; renderResponsiveOrders(); }
      mq.addEventListener ? mq.addEventListener("change", onMedia) : mq.addListener(onMedia);

      // Sesija?
      const session = await checkSession();
      if(session){ await showApp(); await fetchOrders(); subscribeRealtime(); }
      else{ await showLogin(); }

      // Nav
      nav.addEventListener("click", (e)=>{
        const btn = e.target.closest("button[data-view]"); if(!btn) return;
        const v = btn.dataset.view;
        setView(v);
        if(v==="orders") renderOrdersView();
        if(v==="outbox") fetchOutbox();
        if(v==="documents") { /* čeka unos ID-a */ }
        if(v==="analytics") recomputeAnalytics();
        if(v==="settings") {
          document.getElementById("envInfo").textContent = `${location.hostname} • ${SUPABASE_URL}`;
        }
      });

      // Hamburger meni
      btnMenu?.addEventListener("click", openMenu);
      scrim.addEventListener("click", closeMenu);

      // Login (klik + Enter)
      btnLogin.addEventListener("click", (e)=>{ e.preventDefault(); doLogin(); });
      ["email","password"].forEach(id=>{
        const el = document.getElementById(id);
        el.addEventListener("keydown", (e)=>{ if(e.key==="Enter"){ e.preventDefault(); doLogin(); }});
      });

      // Logout
      btnLogout.addEventListener("click", async ()=>{
        try{ await supabase?.auth.signOut(); }catch{}
        orders = rawOrders = []; selectedIds.clear(); currentOrder = null;
        await showLogin();
      });

      // Refresh
      btnRefresh.addEventListener("click", fetchOrders);

      // Filteri (dashboard)
      filterSearch.addEventListener("input", renderResponsiveOrders);
      filterStatus.addEventListener("change", renderResponsiveOrders);
      globalSearch.addEventListener("keydown", e=>{
        if(e.key==="Enter"){ filterSearch.value = globalSearch.value; setView("dashboard"); renderResponsiveOrders(); }
      });

      // Selektovanje (desktop tabela)
      checkAll.addEventListener("change", ()=>{
        selectedIds.clear();
        if(checkAll.checked){
          document.querySelectorAll('#ordersTbody input[type="checkbox"]').forEach(cb=>{ cb.checked=true; selectedIds.add(cb.dataset.id); });
        }else{
          document.querySelectorAll('#ordersTbody input[type="checkbox"]').forEach(cb=>cb.checked=false);
        }
      });
      ordersTbody.addEventListener("change", (e)=>{
        const cb = e.target.closest('input[type="checkbox"][data-id]'); if(!cb) return;
        if(cb.checked) selectedIds.add(cb.dataset.id); else selectedIds.delete(cb.dataset.id);
      });

      // Row / Card actions
      function onRowAction(e){
        const btn = e.target.closest("button[data-act]");
        if(!btn) return;
        const id = btn.dataset.id;
        const order = orders.find(o=>String(o.id)===String(id));
        if(!order) return;

        if(btn.dataset.act==="verify") actVerify(id);
        if(btn.dataset.act==="upload"){ openDrawer(order); drawerFile.click(); }
        if(btn.dataset.act==="send") actSend(id);
        if(btn.dataset.act==="open") openDrawer(order);
      }
      ordersTbody.addEventListener("click", onRowAction);
      ordersCards.addEventListener("click", onRowAction);
      document.getElementById("ordersViewTbody").addEventListener("click", onRowAction);
      document.getElementById("ordersViewCards").addEventListener("click", onRowAction);

      // Drawer
      drawerFile.addEventListener("change", ()=>{
        if(currentOrder && drawerFile.files[0]) actUpload(currentOrder.id, drawerFile.files[0]);
      });
      btnDrawerClose.addEventListener("click", closeDrawer);
      btnDrawerSend.addEventListener("click", ()=> currentOrder && actSend(currentOrder.id));

      // Settings helpers
      document.getElementById("btnPing").addEventListener("click", async ()=>{
        const el = document.getElementById("pingResult");
        try{
          const { error } = await supabase.from("orders").select("id").limit(1);
          el.textContent = error ? "Greška" : "OK";
        }catch{ el.textContent = "Greška"; }
      });

      // Outbox controls
      document.getElementById("outboxRefresh").addEventListener("click", fetchOutbox);
      document.getElementById("outboxStatus").addEventListener("change", fetchOutbox);
      document.getElementById("outboxSearch").addEventListener("input", fetchOutbox);

      // Dokumenti controls
      document.getElementById("docsLoad").addEventListener("click", ()=>{
        const id = document.getElementById("docsOrderId").value.trim();
        listDocs(id);
      });
    });

    function subscribeRealtime(){
      try{
        const ch = supabase.channel('orders-ch')
          .on('postgres_changes',{event:'*', schema:'public', table:'orders'}, ()=>{
            showToast("Ažuriranje narudžbi"); fetchOrders();
          })
          .subscribe((status)=>{
            document.getElementById("sysStatus").textContent = `Realtime: ${status || 'online'} • Cron: — • Storage: —`;
          });
      }catch(e){
        console.warn("Realtime off", e);
        document.getElementById("sysStatus").textContent = "Realtime: offline • Cron: — • Storage: —";
      }
    }
  </script>
</body>
</html>
