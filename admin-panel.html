<!DOCTYPE html><html lang="sr-Latn-ME"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Ugovor24 ‚Äî Admin</title><meta name="robots" content="noindex,nofollow"/>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root{--brand:#007BFF;--ok:#20c997;--bg:#0b0d10;--bg2:#12151a;--panel:#171b22;--muted:#8b95a5;--txt:#e7edf6;--warn:#ffb020;--err:#e85959;--br:#222834;--r:12px}
*{box-sizing:border-box}html,body{height:100%}body{margin:0;background:var(--bg);color:var(--txt);font:14px/1.45 Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}
a{color:inherit;text-decoration:none}.hidden{display:none!important}.muted{color:var(--muted)}.sr{position:absolute;width:1px;height:1px;overflow:hidden;clip:rect(1px,1px,1px,1px)}
.app{display:grid;grid-template-columns:260px 1fr;grid-template-rows:auto 1fr;grid-template-areas:"side head" "side main";min-height:100vh}
.sidebar{grid-area:side;background:var(--panel);border-right:1px solid var(--br);display:flex;flex-direction:column}
.brand{padding:1rem;border-bottom:1px solid var(--br);font-weight:800}
.nav{padding:.6rem}.nav button{width:100%;background:0;border:0;color:inherit;padding:.6rem .7rem;border-radius:10px;text-align:left;cursor:pointer}
.nav button:hover{background:#132540}.nav .act{background:#0f1d35;outline:1px solid #1d3b74}
.sidebar .foot{margin-top:auto;padding:1rem;border-top:1px solid var(--br);font-size:12px;color:var(--muted)}
.header{grid-area:head;background:var(--panel);border-bottom:1px solid var(--br);display:flex;gap:.5rem;align-items:center;padding:.7rem 1rem;position:sticky;top:0;z-index:30}
.badge{background:#141c2b;border:1px solid var(--br);border-radius:999px;padding:.2rem .5rem;color:var(--muted);font-size:12px}
.search{flex:1}.input,.select{width:100%;background:var(--bg2);border:1px solid var(--br);color:var(--txt);border-radius:10px;padding:.55rem .7rem}
.btn{background:#162131;border:1px solid var(--br);color:var(--txt);padding:.5rem .75rem;border-radius:10px;cursor:pointer;font-weight:600}
.bpri{background:var(--brand);border-color:transparent}.bsec{background:transparent}.bsm{padding:.35rem .55rem;font-size:12px;border-radius:8px}
.bok{background:var(--ok);border:0;color:#062016}.bwarn{background:var(--warn);border:0;color:#251d00}.bdan{background:#ff6b6b;border:0}
.loader{position:absolute;left:0;right:0;bottom:-1px;height:2px;background:linear-gradient(90deg,var(--brand),#42a0ff);transform:scaleX(0);transform-origin:left;transition:.25s}.on{transform:scaleX(1)}
.main{grid-area:main;padding:1rem;overflow:auto}
.grid{display:grid;gap:1rem}.cards{grid-template-columns:repeat(4,minmax(160px,1fr))}
.card{background:var(--panel);border:1px solid var(--br);border-radius:var(--r);padding:1rem}
.kpi .lab{color:var(--muted);font-size:12px}.kpi .val{font:800 22px/1 Inter;tabular-nums:tabular-nums}.kpi .d{font-size:12px}
.toolbar{display:flex;gap:.5rem;flex-wrap:wrap;margin:0 0 .75rem}
.table{width:100%;border-collapse:collapse;background:var(--panel);border:1px solid var(--br);border-radius:12px;overflow:hidden}
.table th{background:#141924;color:#aeb7c6;text-align:left;font-weight:600;padding:.6rem;border-bottom:1px solid var(--br);font-size:12px}
.table td{padding:.6rem;border-bottom:1px solid var(--br)}
.bad{display:inline-flex;gap:.35rem;align-items:center;padding:.2rem .5rem;border-radius:8px;font-size:12px;border:1px solid transparent}
.st-paid{background:#0f2a23;color:#7be0c3;border-color:#1f4f44}.st-unpaid{background:#2a0f11;color:#ffb1b1;border-color:#512325}
.st-sent{background:#11243a;color:#9ad1ff;border-color:#224b74}.st-wait{background:#2d2a14;color:#ffe287;border-color:#5c5522}
.split{display:grid;grid-template-columns:2fr 1fr;gap:1rem}.aside{position:sticky;top:1rem;height:fit-content}
.login{max-width:420px;margin:8vh auto}
.drawer{position:fixed;inset:auto 0 0 auto;top:0;width:440px;height:100%;background:var(--panel);border-left:1px solid var(--br);transform:translateX(100%);transition:.25s;z-index:40;display:flex;flex-direction:column}
.drawer.open{transform:translateX(0)}.dh{padding:1rem;border-bottom:1px solid var(--br);display:flex;justify-content:space-between;align-items:center}.db{padding:1rem;overflow:auto;display:grid;gap:.8rem}
.tl{display:grid;gap:.5rem}.dot{width:10px;height:10px;border-radius:50%;background:var(--brand);display:inline-block;margin-right:.4rem}
.toast{position:fixed;right:16px;bottom:16px;background:#10151d;border:1px solid var(--br);padding:.55rem .7rem;border-radius:10px;opacity:0;transform:translateY(8px);transition:.25s;z-index:50}
.toast.show{opacity:1;transform:translateY(0)}
.mob{display:none}
@media(max-width:900px){
  .cards{grid-template-columns:repeat(2,minmax(120px,1fr))}.split{grid-template-columns:1fr}.aside{position:static}
  .app{grid-template-columns:1fr;grid-template-areas:"head" "main"}
  .sidebar{position:fixed;inset:0 auto 0 0;width:86%;max-width:300px;transform:translateX(-100%);transition:.25s;z-index:45}
  .sidebar.open{transform:translateX(0)}.scrim{position:fixed;inset:0;background:rgba(0,0,0,.45);backdrop-filter:blur(2px);opacity:0;pointer-events:none;transition:.2s;z-index:40}
  .scrim.show{opacity:1;pointer-events:auto}.mob{display:block}.desk{display:none}
  .drawer{inset:0;width:100%;border-left:none;border-top:1px solid var(--br);transform:translateY(100%)}.drawer.open{transform:translateY(0)}
  .bottom{position:fixed;left:0;right:0;bottom:0;background:var(--panel);border-top:1px solid var(--br);display:flex;gap:.5rem;padding:.4rem .6rem}
  .bottom button{flex:1}.btn,.input,.select{min-height:44px}
}
button:focus-visible,input:focus-visible,select:focus-visible{outline:2px solid var(--brand);outline-offset:2px}
</style>
</head><body>
<div class="app">
  <aside class="sidebar" id="side">
    <div class="brand">Ugovor24 ‚Ä¢ Admin</div>
    <nav class="nav" id="nav">
      <button data-v="dash" class="act">üìä Dashboard</button>
      <button data-v="orders">üóÇÔ∏è Narud≈æbe</button>
      <button data-v="outbox">‚úâÔ∏è Outbox</button>
      <button data-v="docs">üìÅ Dokumenti</button>
      <button data-v="analytics">üìà Analitika</button>
      <button data-v="settings">‚öôÔ∏è Pode≈°avanja</button>
    </nav>
    <div class="foot">v1 ‚Ä¢ privatno<br><span class="muted">noindex ‚Ä¢ secured</span></div>
  </aside>
  <div class="scrim" id="scrim"></div>
  <header class="header">
    <button id="menu" class="btn mob" aria-label="Meni">‚ò∞</button>
    <span class="badge desk" id="env">Live</span>
    <label for="q" class="sr">Globalna pretraga</label><div class="search"><input id="q" class="input" placeholder="Pretraga (id/email/ugovor)‚Ä¶"></div>
    <button id="ref" class="btn bsec">‚ü≥ Osvje≈æi</button><button id="logout" class="btn">Odjava</button>
    <div id="bar" class="loader"></div>
  </header>
  <main class="main">
    <!-- LOGIN -->
    <section id="v-login" class="login">
      <div class="card">
        <h2>Prijava</h2>
        <label for="em">Email</label><input id="em" type="email" class="input" placeholder="you@example.com" autocomplete="username">
        <label for="pw">Lozinka</label><input id="pw" type="password" class="input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password">
        <button id="doLogin" class="btn bpri" style="width:100%;margin-top:.6rem">Prijavi se</button>
        <div id="lerr" class="muted" style="margin-top:.5rem"></div>
      </div>
    </section>

    <!-- APP -->
    <section id="v-app" class="hidden">
      <!-- DASH -->
      <div id="v-dash" class="grid">
        <div class="grid cards">
          <div class="card kpi"><div class="lab">Narud≈æbe danas</div><div id="kpiToday" class="val">0</div><div class="d muted">‚Äî</div></div>
          <div class="card kpi"><div class="lab">Prihod (30d)</div><div id="kpiRev" class="val">0 ‚Ç¨</div><div class="d muted">‚Äî</div></div>
          <div class="card kpi"><div class="lab">Prosjeƒçno vrijeme</div><div id="kpiTTA" class="val">‚Äî</div><div class="d muted">cilj &lt;24h</div></div>
          <div class="card kpi"><div class="lab">% &lt;24h</div><div id="kpiF24" class="val">‚Äî</div><div class="d muted">‚Äî</div></div>
        </div>
        <div class="split">
          <div class="card">
            <div class="toolbar">
              <label for="fTxt" class="sr">Filter</label><input id="fTxt" class="input" placeholder="email / #id / tip">
              <label for="fSt" class="sr">Status</label><select id="fSt" class="select"><option value="">Status (sve)</option><option value="paid">Plaƒáene</option><option value="unpaid">Neplaƒáene</option><option value="sent">Final poslati</option><option value="wait">ƒåeka final</option></select>
              <button id="bCSV" class="btn bsm">‚á© CSV</button>
            </div>
            <div id="ordersWrap"></div>
          </div>
          <aside class="aside">
            <div class="card"><strong>Critical Queue</strong><ul id="crit" style="margin:.5rem 0 0 1rem;padding:0"></ul></div>
            <div class="card" style="margin-top:1rem"><strong>Sistem status</strong><p id="sys" class="muted">Realtime: ‚Äî ‚Ä¢ Cron: ‚Äî ‚Ä¢ Storage: ‚Äî</p></div>
          </aside>
        </div>
      </div>

      <!-- ORDERS FULL -->
      <div id="v-orders" class="hidden card">
        <div class="toolbar">
          <label for="oTxt" class="sr">Filter</label><input id="oTxt" class="input" placeholder="email / #id / tip">
          <label for="oSt" class="sr">Status</label><select id="oSt" class="select"><option value="">Status (sve)</option><option value="paid">Plaƒáene</option><option value="unpaid">Neplaƒáene</option><option value="sent">Final poslati</option><option value="wait">ƒåeka final</option></select>
          <button id="oCSV" class="btn bsm">‚á© CSV</button>
        </div>
        <div id="ordersFull"></div>
      </div>

      <!-- OUTBOX -->
      <div id="v-outbox" class="hidden card">
        <div class="toolbar">
          <label for="obSt" class="sr">Status</label><select id="obSt" class="select"><option value="">Status (sve)</option><option>queued</option><option>sent</option><option>delivered</option><option>failed</option><option>bounced</option></select>
          <label for="obQ" class="sr">Pretraga</label><input id="obQ" class="input" placeholder="email / subject">
          <button id="obRef" class="btn bsm">‚ü≥</button>
        </div>
        <div id="outboxWrap"></div><p id="obInfo" class="muted" style="margin-top:.5rem"></p>
      </div>

      <!-- DOCS -->
      <div id="v-docs" class="hidden card">
        <div class="toolbar">
          <label for="dId" class="sr">ID narud≈æbe</label><input id="dId" class="input" placeholder="ID narud≈æbe">
          <button id="dLoad" class="btn bsm">Prika≈æi</button><span class="muted">Bucket: <code>ugovori</code></span>
        </div>
        <div id="docsWrap"></div>
      </div>

      <!-- ANALYTICS -->
      <div id="v-analytics" class="hidden grid">
        <div class="grid cards">
          <div class="card kpi"><div class="lab">Narud≈æbi (30d)</div><div id="anCnt" class="val">‚Äî</div></div>
          <div class="card kpi"><div class="lab">Prihod (30d)</div><div id="anRev" class="val">‚Äî</div></div>
          <div class="card kpi"><div class="lab">Prosj. cijena</div><div id="anAvg" class="val">‚Äî</div></div>
          <div class="card kpi"><div class="lab">Top tip</div><div id="anTop" class="val">‚Äî</div></div>
        </div>
        <div class="split">
          <div class="card"><strong>Top tipovi</strong><div id="anTypes" style="margin-top:.5rem"></div></div>
          <div class="aside"><div class="card"><strong>Prihod po danu (14d)</strong><div id="anDays" style="margin-top:.5rem"></div></div></div>
        </div>
      </div>

      <!-- SETTINGS -->
      <div id="v-settings" class="hidden card">
        <strong>Okru≈æenje</strong><p id="envInfo" class="muted">‚Äî</p>
        <div style="margin-top:1rem"><strong>Test konekcije</strong> <button id="ping" class="btn bsm">Ping DB</button> <span id="pingRes" class="muted">‚Äî</span></div>
        <div style="margin-top:1rem"><strong>Back to Dashboard</strong> <button class="btn bsm" data-back="dash">‚Ü©Ô∏é</button></div>
      </div>
    </section>
  </main>
</div>

<!-- DRAWER -->
<div id="drawer" class="drawer" aria-hidden="true" role="dialog" aria-modal="true">
  <div class="dh"><strong id="drTit">Narud≈æba</strong><div><button id="drSend" class="btn bsm bpri">Po≈°alji final</button> <button id="drClose" class="btn bsm">Zatvori</button></div></div>
  <div class="db">
    <div><div class="muted">Klijent</div><div id="drCli">‚Äî</div></div>
    <div><div class="muted">Tip ugovora</div><div id="drType">‚Äî</div></div>
    <div><div class="muted">Iznos</div><div id="drAmt">‚Äî</div></div>
    <div><div class="muted">Finalni fajl</div><input id="drFile" type="file"></div>
    <div><div class="muted">Timeline</div><div id="drTl" class="tl"></div></div>
  </div>
</div>

<!-- Bottom nav (mobile) -->
<nav class="bottom mob"><button data-v="dash" class="btn bsec">üè† Dashboard</button><button data-v="orders" class="btn bsec">üóÇÔ∏è Orders</button><button data-v="outbox" class="btn bsec">‚úâÔ∏è Outbox</button></nav>

<div id="toast" class="toast">Poruka</div>

<script>
"use strict";
/* CONFIG */
const SUPABASE_URL="https://jgkllsxeuoozpglzwxwg.supabase.co";
const SUPABASE_ANON_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impna2xsc3hldW9venBnbHp3eHdnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ5MjEyNjgsImV4cCI6MjA3MDQ5NzI2OH0.vEaqZbeoVK1MOdVL6mm7CoABRuuJUcuOXT5-IfZSUsc";
const API_FINAL="/api/finalize-contract.js";
const sb=window.supabase?.createClient(SUPABASE_URL,SUPABASE_ANON_KEY);
/* STATE+ELS */
let ORD=[], CUR=null, isMob=matchMedia("(max-width:900px)").matches;
const el=id=>document.getElementById(id), $={login:el("v-login"),app:el("v-app"),dash:el("v-dash"),orders:el("v-orders"),outbox:el("v-outbox"),docs:el("v-docs"),analytics:el("v-analytics"),settings:el("v-settings")}, drawer=el("drawer");
/* HELPERS */
const load=b=>el("bar").classList.toggle("on",!!b), toast=t=>{const x=el("toast");x.textContent=t;x.classList.add("show");setTimeout(()=>x.classList.remove("show"),1600)};
const fmtE=v=>Intl.NumberFormat("sr-ME",{style:"currency",currency:"EUR",maximumFractionDigits:0}).format(v||0), pad=(n,w=5)=>String(n).padStart(w,"0");
const ST={paid:{c:"st-paid",t:"Uplaƒáeno",i:"‚úÖ"},unpaid:{c:"st-unpaid",t:"Na ƒçekanju",i:"‚è≥"},sent:{c:"st-sent",t:"Poslato",i:"üì§"},wait:{c:"st-wait",t:"ƒåeka",i:"‚ùå"}};
const badge=k=>`<span class="bad ${ST[k].c}">${ST[k].i} ${ST[k].t}</span>`;
const session=()=>sb.auth.getSession().then(r=>r.data.session);
/* VIEW */
function setView(v){Object.values($).forEach(x=>x.classList.add("hidden"));$.app.classList.remove("hidden");({dash:$.dash,orders:$.orders,outbox:$.outbox,docs:$.docs,analytics:$.analytics,settings:$.settings}[v]||$.dash).classList.remove("hidden");
  document.querySelectorAll(".nav button").forEach(b=>b.classList.toggle("act",b.dataset.v===v));
  document.querySelectorAll(".bottom [data-v]").forEach(b=>b.classList.toggle("bpri",b.dataset.v===v));
  if(v==="outbox") fetchOutbox(); if(v==="analytics") renderAnalytics(); if(v==="settings") el("envInfo").textContent=`${location.hostname} ‚Ä¢ ${SUPABASE_URL}`;
}
/* ORDERS */
async function fetchOrders(){ if(!sb) return; load(1); const {data,error}=await sb.from("orders").select("*").order("created_at",{ascending:false}); load(0);
  if(error){ el("ordersWrap").innerHTML='<div class="muted">Gre≈°ka pri uƒçitavanju.</div>'; return;}
  ORD=data||[]; kpis(); renderOrders(); renderCritical();
}
function kpis(){ const t=new Date().toDateString(); const cnt=ORD.filter(o=>new Date(o.created_at).toDateString()===t).length; const rev=ORD.reduce((s,o)=>{const d=new Date(o.created_at);return (Date.now()-d)/86400000<=30?s+(+o.total_price||0):s},0);
  el("kpiToday").textContent=cnt; el("kpiRev").textContent=fmtE(rev);
}
const fO=(txt,st)=>{txt=(txt||"").toLowerCase();return ORD.filter(o=>{const hit=!txt||String(o.order_number).includes(txt)||(o.client_email||"").toLowerCase().includes(txt)||(o.ugovor_type||"").toLowerCase().includes(txt);if(!hit)return false;
  if(st==="paid"&&!o.is_paid) return false; if(st==="unpaid"&&o.is_paid) return false; if(st==="sent"&&!o.is_final_approved) return false; if(st==="wait"&&o.is_final_approved) return false; return true})};
function renderList({wrap,rows,cols,onRow}){const m=isMob,W=el(wrap); if(!rows.length){W.innerHTML='<div class="muted">Nema stavki.</div>';return;}
  if(!m){W.innerHTML=`<table class="table"><thead><tr>${cols.map(c=>`<th>${c.h}</th>`).join("")}</tr></thead><tbody>${rows.map(r=>`<tr data-id="${r.id}">${cols.map(c=>`<td>${c.cell(r)}</td>`).join("")}</tr>`).join("")}</tbody></table>`;
    W.querySelectorAll("tr[data-id]").forEach(tr=>tr.addEventListener("click",e=>{if(e.target.closest("button,[data-act]"))return;onRow(tr.dataset.id)}));
    W.addEventListener("click",e=>{const b=e.target.closest("[data-act]"); if(b) onAct(b.dataset.act,b.dataset.id);});
  }else{W.innerHTML=rows.map(r=>`<div class="card" data-id="${r.id}" style="display:grid;gap:.4rem;cursor:pointer">
    <div style="display:flex;justify-content:space-between"><strong>#${pad(r.order_number||r.id)}</strong><span class="muted">${r.ugovor_type||"‚Äî"}</span></div>
    <div style="display:flex;justify-content:space-between"><span class="muted">${r.client_email||"‚Äî"}</span><span>${fmtE(+r.total_price||0)}</span></div>
    <div style="display:flex;gap:.4rem;flex-wrap:wrap">${r.is_paid?badge('paid'):badge('unpaid')} ${r.is_final_approved?badge('sent'):badge('wait')}</div>
    <div style="display:flex;gap:.35rem;flex-wrap:wrap"><button class="btn bsm bok" data-act="verify" data-id="${r.id}" ${r.is_paid?'disabled':''}>Verifikuj</button><button class="btn bsm" data-act="upload" data-id="${r.id}">Prilo≈æi</button><button class="btn bsm bpri" data-act="send" data-id="${r.id}" ${(r.is_paid&&r.final_document_url&&!r.is_final_approved)?'':'disabled'}>Po≈°alji</button><button class="btn bsm" data-act="open" data-id="${r.id}">Detalji</button></div>
  </div>`).join(""); W.querySelectorAll(".card").forEach(c=>c.addEventListener("click",e=>{if(e.target.closest("button"))return;onRow(c.dataset.id)})); W.addEventListener("click",e=>{const b=e.target.closest("[data-act]"); if(b) onAct(b.dataset.act,b.dataset.id);});}
}
function renderOrders(){const rows=fO(el("fTxt").value,el("fSt").value); renderList({wrap:"ordersWrap",rows,cols:[
  {h:"#",cell:o=>"#"+pad(o.order_number||o.id)},{h:"Ugovor",cell:o=>o.ugovor_type||"‚Äî"},{h:"Klijent",cell:o=>o.client_email||"‚Äî"},
  {h:"Iznos",cell:o=>fmtE(+o.total_price||0)},{h:"Uplata",cell:o=>o.is_paid?badge('paid'):badge('unpaid')},{h:"Final",cell:o=>o.is_final_approved?badge('sent'):badge('wait')},
  {h:"Akcije",cell:o=>`<button class="btn bsm bok" data-act="verify" data-id="${o.id}" ${o.is_paid?'disabled':''}>Verifikuj</button> <button class="btn bsm" data-act="upload" data-id="${o.id}">Prilo≈æi</button> <button class="btn bsm bpri" data-act="send" data-id="${o.id}" ${(o.is_paid&&o.final_document_url&&!o.is_final_approved)?'':'disabled'}>Po≈°alji</button> <button class="btn bsm" data-act="open" data-id="${o.id}">Detalji</button>`}
],onRow:id=>openDrawer(ORD.find(o=>String(o.id)===String(id)))})}
const renderOrdersFull=()=>{const rows=fO(el("oTxt").value,el("oSt").value); renderList({wrap:"ordersFull",rows,cols:[
  {h:"#",cell:o=>"#"+pad(o.order_number||o.id)},{h:"Ugovor",cell:o=>o.ugovor_type||"‚Äî"},{h:"Klijent",cell:o=>o.client_email||"‚Äî"},
  {h:"Iznos",cell:o=>fmtE(+o.total_price||0)},{h:"Uplata",cell:o=>o.is_paid?badge('paid'):badge('unpaid')},{h:"Final",cell:o=>o.is_final_approved?badge('sent'):badge('wait')},
  {h:"Akcije",cell:o=>`<button class="btn bsm bok" data-act="verify" data-id="${o.id}" ${o.is_paid?'disabled':''}>Verifikuj</button> <button class="btn bsm" data-act="upload" data-id="${o.id}">Prilo≈æi</button> <button class="btn bsm bpri" data-act="send" data-id="${o.id}" ${(o.is_paid&&o.final_document_url&&!o.is_final_approved)?'':'disabled'}>Po≈°alji</button> <button class="btn bsm" data-act="open" data-id="${o.id}">Detalji</button>`}
],onRow:id=>openDrawer(ORD.find(o=>String(o.id)===String(id)))})};
function renderCritical(){const it=ORD.filter(o=>o.is_paid&&!o.is_final_approved); el("crit").innerHTML=it.length?it.map(o=>`<li>#${pad(o.order_number)} ‚Ä¢ ${o.client_email} ‚Ä¢ ƒçeka final</li>`).join(""):`<li class="muted">Nema kritiƒçnih stavki.</li>`}
/* DRAWER + ACTIONS */
function openDrawer(o){if(!o) return; CUR=o; el("drTit").textContent=`Narud≈æba #${pad(o.order_number||o.id)}`; el("drCli").textContent=o.client_email||"‚Äî"; el("drType").textContent=o.ugovor_type||"‚Äî"; el("drAmt").textContent=fmtE(+o.total_price||0);
  el("drTl").innerHTML=`<div><span class="dot"></span>Kreirano <span class="muted">${new Date(o.created_at).toLocaleString()}</span></div>
  <div><span class="dot" style="background:${o.is_paid?'#20c997':'#555'}"></span>Uplata ${o.is_paid?'potvrƒëena':'na ƒçekanju'}</div>
  <div><span class="dot" style="background:${o.final_document_url?'#42a0ff':'#555'}"></span>Finalni fajl ${o.final_document_url?'prilo≈æen':'nije prilo≈æen'}</div>
  <div><span class="dot" style="background:${o.is_final_approved?'#42a0ff':'#555'}"></span>Final poslat ${o.is_final_approved?'‚úì':'‚Äî'}</div>`;
  drawer.classList.add("open"); drawer.setAttribute("aria-hidden","false");
}
function closeDrawer(){drawer.classList.remove("open");drawer.setAttribute("aria-hidden","true");CUR=null;el("drFile").value=""}
async function token(){const s=await session();return s?.access_token||null}
async function onAct(a,id){const o=ORD.find(x=>String(x.id)===String(id)); if(!o) return;
  if(a==="verify"){const tk=await token(); if(!tk) return toast("Sesija istekla"); load(1); const r=await fetch(API_FINAL,{method:"POST",headers:{'Content-Type':'application/json','Authorization':`Bearer ${tk}`},body:JSON.stringify({action:"verify_payment",order_id:id})}); load(0); r.ok?(toast("Uplata verifikovana"),fetchOrders()):toast("Gre≈°ka verifikacije")}
  if(a==="upload"){openDrawer(o); el("drFile").click()}
  if(a==="send"){const tk=await token(); if(!tk) return toast("Sesija istekla"); load(1); const r=await fetch(API_FINAL,{method:"POST",headers:{'Content-Type':'application/json','Authorization':`Bearer ${tk}`},body:JSON.stringify({action:"send_final",order_id:id})}); load(0); r.ok?(toast("Final poslat"),fetchOrders()):toast("Gre≈°ka slanja")}
  if(a==="open"){openDrawer(o)}
}
el("drFile").addEventListener("change",async()=>{if(!CUR||!el("drFile").files[0])return; const f=el("drFile").files[0]; const {data,error}=await sb.storage.from("ugovori").upload(`${CUR.id}/${f.name}`,f,{cacheControl:"3600",upsert:true}); if(error){toast("Gre≈°ka upload");return}
  const url=`${SUPABASE_URL}/storage/v1/object/public/ugovori/${data.path}`; const tk=await token(); load(1);
  const r=await fetch(API_FINAL,{method:"POST",headers:{'Content-Type':'application/json','Authorization':`Bearer ${tk}`},body:JSON.stringify({action:"upload_file",order_id:CUR.id,fileUrl:url})}); load(0);
  r.ok?(toast("Fajl prilo≈æen"),fetchOrders()):toast("Gre≈°ka prilaganja")
});
el("drSend").onclick=()=>CUR&&onAct("send",CUR.id); el("drClose").onclick=closeDrawer;
/* CSV */
function csv(rows,name){const H=["id","order_number","ugovor_type","client_email","total_price","is_paid","is_final_approved","created_at"];const all=[H,...rows.map(o=>H.map(k=>o[k]))];const s=all.map(r=>r.map(x=>`"${String(x??"").replace(/"/g,'""')}"`).join(",")).join("\n");const a=document.createElement("a");a.href=URL.createObjectURL(new Blob([s],{type:"text/csv"}));a.download=name;a.click()}
/* OUTBOX */
async function fetchOutbox(){const {data,error}=await sb.from("email_outbox").select("*").order("created_at",{ascending:false}).limit(200);
  const st=el("obSt").value,q=(el("obQ").value||"").toLowerCase(); const rows=(data||[]).filter(r=>(!st||r.status===st)&&(!q||(String(r.to||"").toLowerCase().includes(q)||String(r.subject||"").toLowerCase().includes(q))));
  const W=el("outboxWrap"); if(!rows.length){W.innerHTML='<div class="muted">Nema stavki.</div>'; if(error) el("obInfo").innerHTML='Napomena: kreiraj tabelu <code>public.email_outbox</code>.'; return}
  if(!isMob){W.innerHTML=`<table class="table"><thead><tr><th>Vrijeme</th><th>Kome</th><th>Predmet</th><th>≈†ablon</th><th>Status</th><th>Provider ID</th></tr></thead><tbody>`+
    rows.map(r=>`<tr><td>${new Date(r.created_at).toLocaleString()}</td><td>${r.to||"‚Äî"}</td><td>${r.subject||"‚Äî"}</td><td>${r.template||"‚Äî"}</td><td>${r.status||"‚Äî"}</td><td>${r.provider_id||"‚Äî"}</td></tr>`).join("")+`</tbody></table>`}
  else{W.innerHTML=rows.map(r=>`<div class="card" style="display:grid;gap:.35rem">
    <div style="display:flex;justify-content:space-between"><strong>${r.subject||"‚Äî"}</strong><span class="bad ${r.status==='sent'?'st-sent':r.status==='delivered'?'st-sent':r.status==='failed'?'st-unpaid':'st-wait'}">${r.status||"‚Äî"}</span></div>
    <div class="muted">${new Date(r.created_at).toLocaleString()}</div>
    <div style="display:flex;justify-content:space-between"><span>Kome:</span><span>${r.to||"‚Äî"}</span></div>
    <div style="display:flex;justify-content:space-between"><span>≈†ablon:</span><span>${r.template||"‚Äî"}</span></div>
    <div class="muted">Provider: ${r.provider_id||"‚Äî"}</div></div>`).join("")}
}
/* DOCS */
async function listDocs(id){const W=el("docsWrap"); if(!id){W.innerHTML='<div class="muted">Unesi ID narud≈æbe.</div>';return}
  const {data,error}=await sb.storage.from("ugovori").list(`${id}`,{limit:100}); if(error){W.innerHTML='<div class="muted">Gre≈°ka pri listanju.</div>';return}
  if(!data?.length){W.innerHTML='<div class="muted">Nema fajlova.</div>';return}
  if(!isMob){W.innerHTML=`<table class="table"><thead><tr><th>Fajl</th><th>Veliƒçina</th><th>Modifikovano</th><th></th></tr></thead><tbody>`+
    data.map(f=>{const p=`${id}/${f.name}`;const url=sb.storage.from("ugovori").getPublicUrl(p).data?.publicUrl||"#";const s=(f?.metadata?.size||f?.size||0);return `<tr><td>${f.name}</td><td>${s?Math.round(s/1024)+" KB":"‚Äî"}</td><td>${f?.updated_at?new Date(f.updated_at).toLocaleString():"‚Äî"}</td><td><a class="btn bsm" href="${url}" target="_blank" rel="noopener">Preuzmi</a></td></tr>`}).join("")+`</tbody></table>`}
  else{W.innerHTML=data.map(f=>{const p=`${id}/${f.name}`;const url=sb.storage.from("ugovori").getPublicUrl(p).data?.publicUrl||"#";const s=(f?.metadata?.size||f?.size||0);
    return `<div class="card" style="display:flex;justify-content:space-between;align-items:center;gap:.5rem"><div><div><strong>${f.name}</strong></div><div class="muted">${s?Math.round(s/1024)+" KB":"‚Äî"} ‚Ä¢ ${f?.updated_at?new Date(f.updated_at).toLocaleString():"‚Äî"}</div></div><a class="btn bsm" href="${url}" target="_blank" rel="noopener">‚¨áÔ∏é</a></div>`}).join("")}
}
/* ANALYTICS */
function renderAnalytics(){const now=Date.now(),d14=14,byD=new Map(),byT=new Map(); let cnt30=0,rev30=0;
  for(const o of ORD){const t=new Date(o.created_at).getTime(); if((now-t)/86400000<=30){cnt30++;rev30+=(+o.total_price||0)} const day=new Date(o.created_at).toISOString().slice(0,10); byD.set(day,(byD.get(day)||0)+(+o.total_price||0)); const tp=o.ugovor_type||"‚Äî"; const a=byT.get(tp)||{c:0,r:0}; a.c++; a.r+=(+o.total_price||0); byT.set(tp,a)}
  el("anCnt").textContent=cnt30; el("anRev").textContent=fmtE(rev30); el("anAvg").textContent=cnt30?fmtE(rev30/cnt30):"‚Äî";
  const top=[...byT.entries()].sort((a,b)=>b[1].c-a[1].c)[0]; el("anTop").textContent=top?`${top[0]} (${top[1].c})`:"‚Äî";
  el("anTypes").innerHTML=[...byT.entries()].sort((a,b)=>b[1].c-a[1].c).map(([k,v])=>`<div style="display:flex;justify-content:space-between"><span>${k}</span><span>${v.c} ‚Ä¢ ${fmtE(v.r)}</span></div>`).join("")||'<div class="muted">Nema pod.</div>';
  const rows=[]; for(let i=d14-1;i>=0;i--){const d=new Date(now-i*86400000).toISOString().slice(0,10); rows.push(`<div style="display:flex;justify-content:space-between"><span>${d}</span><span>${fmtE(byD.get(d)||0)}</span></div>`)} el("anDays").innerHTML=rows.join("");
}
/* REALTIME */
function subRT(){try{sb.channel('orders-ch').on('postgres_changes',{event:'*',schema:'public',table:'orders'},()=>{toast("A≈æuriranje narud≈æbi");fetchOrders()}).subscribe(s=>{el("sys").textContent=`Realtime: ${s||'online'} ‚Ä¢ Cron: ‚Äî ‚Ä¢ Storage: ‚Äî`})}catch(e){el("sys").textContent="Realtime: offline ‚Ä¢ Cron: ‚Äî ‚Ä¢ Storage: ‚Äî"}}
/* EVENTS */
document.addEventListener("DOMContentLoaded",async()=>{
  matchMedia("(max-width:900px)").addEventListener?.("change",(e)=>{isMob=e.matches; renderOrders(); if(!$.outbox.classList.contains("hidden")) fetchOutbox(); if(!$.docs.classList.contains("hidden")) listDocs(el("dId").value)});
  el("menu").onclick=()=>{el("side").classList.add("open"); el("scrim").classList.add("show")}; el("scrim").onclick=()=>{el("side").classList.remove("open"); el("scrim").classList.remove("show")};
  document.querySelector(".bottom")?.addEventListener("click",e=>{const b=e.target.closest("button[data-v]"); if(b) setView(b.dataset.v)});
  el("nav").addEventListener("click",e=>{const b=e.target.closest("button[data-v]"); if(!b)return; setView(b.dataset.v); el("side").classList.remove("open"); el("scrim").classList.remove("show")});
  el("ref").onclick=fetchOrders; el("logout").onclick=async()=>{await sb?.auth.signOut(); $.app.classList.add("hidden"); $.login.classList.remove("hidden")};
  el("fTxt").oninput=renderOrders; el("fSt").onchange=renderOrders; el("oTxt").oninput=renderOrdersFull; el("oSt").onchange=renderOrdersFull;
  el("bCSV").onclick=()=>csv(fO(el("fTxt").value,el("fSt").value),"orders.csv"); el("oCSV").onclick=()=>csv(fO(el("oTxt").value,el("oSt").value),"orders.csv");
  el("obRef").onclick=fetchOutbox; el("obSt").onchange=fetchOutbox; el("obQ").oninput=fetchOutbox;
  el("dLoad").onclick=()=>listDocs(el("dId").value);
  el("q").addEventListener("keydown",e=>{if(e.key==="Enter"){el("fTxt").value=el("q").value; setView("dash"); renderOrders()}});
  el("ping").onclick=async()=>{const {error}=await sb.from("orders").select("id").limit(1); el("pingRes").textContent=error?"Gre≈°ka":"OK"};
  document.querySelector('[data-back="dash"]').onclick=()=>setView("dash");
  const s=await session(); if(s){$.login.classList.add("hidden");$.app.classList.remove("hidden"); setView("dash"); await fetchOrders(); subRT(); } else { $.login.classList.remove("hidden"); $.app.classList.add("hidden"); }
  el("doLogin").onclick=async()=>{const {error}=await sb.auth.signInWithPassword({email:el("em").value.trim(),password:el("pw").value}); if(error){el("lerr").textContent=error.message||"Gre≈°ka pri prijavi."}else{$.login.classList.add("hidden");$.app.classList.remove("hidden"); setView("dash"); fetchOrders(); subRT();}};
});
</script>
</body></html>
